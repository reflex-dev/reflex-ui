"""Plain chat integration for customer support.

This module provides integration with Plain.com chat widget for live customer support.
See: https://plain.support.site/article/chat-customization
"""

import os
from typing import Any

import reflex as rx
from reflex.components.tags.tag import Tag

PLAIN_APP_ID = os.getenv("PLAIN_APP_ID", "liveChatApp_01KGG4JD5JHG8JY8X5CCN7811V")


class PlainChat(rx.Component):
    """Plain chat widget component."""

    tag = "PlainChat"

    full_name: rx.Var[str]
    short_name: rx.Var[str]
    chat_avatar_url: rx.Var[str]
    external_id: rx.Var[str]
    hide_launcher: rx.Var[bool] = rx.Var.create(True)

    # Optional email authentication
    email: rx.Var[str] = rx.Var.create("")
    email_hash: rx.Var[str] = rx.Var.create("")

    # Optional built-in email verification
    require_authentication: rx.Var[bool] = rx.Var.create(False)

    def add_imports(self) -> dict:
        """Add React imports."""
        return {"react": ["useEffect"]}

    def add_hooks(self) -> list[str | rx.Var]:
        """Add hooks to initialize Plain chat widget."""
        return [
            rx.Var(
                f"""useEffect(() => {{
  if (typeof window === 'undefined') return;

  const customerDetails = {{
    fullName: {self.full_name!s},
    shortName: {self.short_name!s},
    chatAvatarUrl: {self.chat_avatar_url!s},
  }};

  // Add email if provided
  if ({self.email!s}) {{
    customerDetails.email = {self.email!s};
  }}
  if ({self.email_hash!s}) {{
    customerDetails.emailHash = {self.email_hash!s};
  }}

  const initOptions = {{
    appId: '{PLAIN_APP_ID}',
    hideLauncher: {self.hide_launcher!s},
    hideBranding: true,
    theme: 'auto',
    customerDetails: customerDetails,
    threadDetails: {{
      externalId: {self.external_id!s},
    }},
  }};

  // Add requireAuthentication if true
  if ({self.require_authentication!s}) {{
    initOptions.requireAuthentication = true;
  }}

  if (window.Plain) {{
    if (Plain.isInitialized()) {{
      // Already initialized, update in-place
      // Exclude appId from update - it's only valid for init()
      const {{ appId, ...updateOptions }} = initOptions;
      Plain.update(updateOptions);
    }} else {{
      Plain.init(initOptions);
    }}
    return;
  }}

  const script = document.createElement('script');
  script.async = false;
  script.src = 'https://chat.cdn-plain.com/index.js';
  script.onload = () => Plain.init(initOptions);
  document.head.appendChild(script);
}}, [{self.full_name!s}, {self.short_name!s}, {self.chat_avatar_url!s}, {self.external_id!s}, {self.email!s}, {self.email_hash!s}])"""
            )
        ]

    def _render(self, props: dict[str, Any] | None = None) -> Tag:
        """Render empty tag."""
        return Tag("")


plain_chat = PlainChat.create


def open_plain_chat() -> rx.event.EventSpec:
    """Open the Plain chat widget."""
    return rx.call_script(
        "try { Plain.open(); } catch (e) { console.error('Plain chat not available:', e); }"
    )
